https://chatgpt.com/share/67d80fe3-e66c-8002-9387-af30af4d474a


ğŸ›  1. Architecture de la rÃ©plication
MariaDB utilise une rÃ©plication asynchrone oÃ¹ un Master Ã©crit les changements et les Slaves les lisent.

ğŸ“Œ Ce quâ€™on va faire :
âœ” Un Master (ğŸ“Œ db1) qui reÃ§oit les Ã©critures.
âœ” Un Slave (ğŸ“Œ db2) qui lit les donnÃ©es du Master.
âœ” Configuration de la rÃ©plication avec binlogs et utilisateur de rÃ©plication.

ğŸ“œ 2. Configuration docker-compose.yml
CrÃ©e un fichier docker-compose.yml avec la configuration suivante :

    Vous allez trouver les instances dans le fichier docker-compose.yml

ğŸš€ Explication :

Le Master (db1) â†’ Contient la base et enregistre les binlogs.
Le Slave (db2) â†’ Se synchronise avec le Master.

Les fichiers master.cnf et slave.cnf â†’ Configurations spÃ©cifiques pour la rÃ©plication.
ğŸ“‚ 3. Configurer master.cnf et slave.cnf
ğŸ“ Fichier master.cnf (ğŸ“ Ã  placer dans ./master.cnf)

[mysqld]
server-id=1
log_bin=/var/lib/mysql/mysql-bin.log
binlog-do-db=replication_db

ğŸ“ Fichier slave.cnf (ğŸ“ Ã  placer dans ./slave.cnf)

[mysqld]
server-id=2
relay-log=/var/lib/mysql/mysql-relay-bin.log
read_only=1


ğŸ”§ 4. DÃ©marrer et configurer la rÃ©plication
1ï¸âƒ£ DÃ©marrer les conteneurs:

    docker-compose up -d

2ï¸âƒ£ Se connecter au Master (db1) et crÃ©er un utilisateur de rÃ©plication

Avant il faut modifier le system pour permettre a nos instance mariadb de lire les fichier confs.
    
    --- slave ----
    docker exec -it slave bash
    chown -R mysql:mysql /var/lib/mysql
    chmod -R 750 /var/lib/mysql
   
    --- master ---
    docker exec -it master bash
    cd etc/mysql
    chmod 644 ./master.cnf

    644 signifie lecture/Ã©criture pour le propriÃ©taire, lecture seule pour les autres (-rw-r--r--).
    750 siginifie : 
        
        7 (rwx) : Lâ€™utilisateur (mysql) peut lire, Ã©crire, exÃ©cuter.
        5 (r-x) : Le groupe (mysql) peut lire et exÃ©cuter.
        0 (---) : Les autres utilisateurs nâ€™ont aucun accÃ¨s.

    docker-compose down
    docker-compose up -d


Entre dans le conteneur Master :
    
    docker exec -it master mariadb --user=uroot --password=master

Dans le shell MariaDB, exÃ©cute :

    CREATE USER 'repl_user'@'%' IDENTIFIED BY 'repl_pass';
    GRANT REPLICATION SLAVE ON *.* TO 'repl_user'@'%';
    FLUSH PRIVILEGES;
    SHOW MASTER STATUS;

    --- test commande ---
    SHOW VARIABLES LIKE 'log_bin%';

    --> pour savoir ci le log est utiliser pour la replication

ğŸ“Œ Note le File et la Position du SHOW MASTER STATUS;, on en aura besoin pour le Slave.
ğŸ“Œ Exemple de sortie :

    +------------------+----------+--------------+------------------+
    | File            | Position | Binlog_Do_DB | Binlog_Ignore_DB |
    +------------------+----------+--------------+------------------+
    | mysql-bin.000001 | 154      | replication_db |                  |
    +------------------+----------+--------------+------------------+

3ï¸âƒ£ Configurer le Slave (db2)
Connecte-toi au Slave :

    docker exec -it slave mariadb --user=root --password=test

Configure la rÃ©plication avec les infos du Master (File et Position rÃ©cupÃ©rÃ©s prÃ©cÃ©demment) :

    CHANGE MASTER TO 
    MASTER_HOST='master',
    MASTER_USER='repl_user',
    MASTER_PASSWORD='repl_pass',
    MASTER_LOG_FILE='mysql-bin.000001',  --> deposer le fichier trouvez ici
    MASTER_LOG_POS=154; --> DEPOSER LA POSITION ICI  !!!!

    START SLAVE;
    SHOW SLAVE STATUS\G

âœ… Si tout fonctionne bien, tu verras Slave_IO_Running: Yes et Slave_SQL_Running: Yes.

ğŸ“ 5. Tester la rÃ©plication
Sur le Master (db1), ajoute une table :

    USE master;
    CREATE TABLE test_table (id INT PRIMARY KEY AUTO_INCREMENT, name VARCHAR(50));
    INSERT INTO test_table (name) VALUES ('Hello Replication');

Sur le Slave (db2), exÃ©cute :

    USE master;
    SELECT * FROM test_table;

ğŸ‰ Tu devrais voir la mÃªme table et les mÃªmes donnÃ©es que sur le Master ! ğŸ‰

ğŸš€ RÃ©sumÃ©
âœ… docker-compose.yml pour gÃ©rer les conteneurs.
âœ… Fichiers master.cnf et slave.cnf pour configurer la rÃ©plication.
âœ… CrÃ©ation dâ€™un utilisateur de rÃ©plication (repl_user).
âœ… Configuration et dÃ©marrage du Slave (CHANGE MASTER TO ...).
âœ… Test en insÃ©rant des donnÃ©es sur le Master et en les retrouvant sur le Slave.

ğŸ”¹ AmÃ©liorations possibles :

ğŸ“Œ Ajouter plusieurs Slaves en leur assignant un server-id diffÃ©rent.
ğŸ“Œ Configurer une rÃ©plication semi-synchrone pour Ã©viter la perte de donnÃ©es.
ğŸ“Œ Ajouter Healthchecks pour dÃ©tecter une panne du Master.
Si tu veux aller plus loin, dis-moi ce que tu cherches Ã  faire ! ğŸš€ğŸ”¥
